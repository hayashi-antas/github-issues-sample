name: AI Review on /ai-review

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: read
  issues: write

jobs:
  ai-review:
    if: ${{ 
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/ai-review') &&
      (
        github.event.comment.author_association == 'OWNER' ||
        github.event.comment.author_association == 'MEMBER' ||
        github.event.comment.author_association == 'COLLABORATOR'
      )
    }}
    runs-on: ubuntu-latest

    steps:
      - name: AI review (OpenAI) and comment back
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4.1
        with:
          github-token: ${{ secrets.AI_REVIEW_PAT }}
          script: |
            const openaiKey = process.env.OPENAI_API_KEY;
            const model = process.env.OPENAI_MODEL || "gpt-4.1";

            if (!openaiKey) {
              core.setFailed("Missing OPENAI_API_KEY (GitHub Secrets).");
              return;
            }

            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const issue_number = context.payload.issue.number; // PRç•ªå·ã¨åŒã˜

            // PRæœ¬ä½“ã‚’å–å¾—
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: issue_number
            });

            // diff ã‚’å–å¾—ï¼ˆGitHub APIã« Accept: diff ã‚’æŒ‡å®šï¼‰
            const diffRes = await github.request("GET /repos/{owner}/{repo}/pulls/{pull_number}", {
              owner,
              repo,
              pull_number: issue_number,
              headers: { accept: "application/vnd.github.v3.diff" }
            });
            const diff = String(diffRes.data || "");

            const trimDiff = (text, maxChars = 120000) =>
              text.length > maxChars ? text.slice(0, maxChars) + "\n\n[TRUNCATED]\n" : text;

            const prompt = `
            ã‚ãªãŸã¯ç†Ÿç·´ã—ãŸã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®Pull Requestã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

            ## PRã‚¿ã‚¤ãƒˆãƒ«
            ${pr.data.title}

            ## PRæœ¬æ–‡
            ${pr.data.body || "(ãªã—)"}

            ## å¤‰æ›´å·®åˆ†ï¼ˆdiffï¼‰
            ${trimDiff(diff)}

            è¦³ç‚¹:
            - ãƒã‚°/è½ã¨ã—ç©´ï¼ˆå¢ƒç•Œæ¡ä»¶ã€ä¾‹å¤–ã€NULLã€äº’æ›æ€§ï¼‰
            - ä¿å®ˆæ€§/å¯èª­æ€§ï¼ˆå‘½åã€è²¬å‹™ã€é‡è¤‡ï¼‰
            - ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ï¼ˆãƒ­ã‚°ã€å…¥åŠ›æ¤œè¨¼ã€æ¨©é™ã€æƒ…å ±æ¼ãˆã„ï¼‰
            - ãƒ†ã‚¹ãƒˆè¦³ç‚¹ï¼ˆè¿½åŠ ã™ã¹ããƒ†ã‚¹ãƒˆã€ç¢ºèªãƒã‚¤ãƒ³ãƒˆï¼‰

            ãƒˆãƒ¼ãƒ³:
            - ä¸å¯§ã§å»ºè¨­çš„
            - ä¸ç¢ºã‹ãªç‚¹ã¯æ¨æ¸¬ã¨æ˜è¨˜
            - åˆå¿ƒè€…ã«ã‚‚å­¦ã³ãŒã‚ã‚‹æ›¸ãæ–¹

            Markdownã§å‡ºåŠ›ã—ã¦ãã ã•ã„ã€‚
            `.trim();

            const res = await fetch("https://api.openai.com/v1/responses", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${openaiKey}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model,
                input: prompt
              })
            });

            if (!res.ok) {
              const text = await res.text();
              core.setFailed(`OpenAI API error ${res.status}: ${text}`);
              return;
            }

            const data = await res.json();
            const review = (data.output_text || "").trim() || "ï¼ˆAIãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼‰";

            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number,
              body: `### ğŸ¤– AI Review\n\n${review}\n\n---\n_Trigger: /ai-review_`
            });
