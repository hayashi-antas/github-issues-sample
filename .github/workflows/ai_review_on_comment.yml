name: AI Review on /ai-review

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  debug-context:
    if: ${{ github.event.issue.pull_request != null && contains(github.event.comment.body, '/ai-review') }}
    runs-on: ubuntu-latest
    steps:
      - name: Print event debug info
        run: |
          echo "is_pr=${{ github.event.issue.pull_request != null }}"
          echo "author=${{ github.event.comment.user.login }}"
          echo "author_association=${{ github.event.comment.author_association }}"
          echo "issue_number=${{ github.event.issue.number }}"
          echo "body=${{ github.event.comment.body }}"

  ai-review:
    needs: debug-context
    if: ${{ github.event.issue.pull_request != null && contains(github.event.comment.body, '/ai-review') && (github.event.comment.author_association == 'OWNER' || github.event.comment.author_association == 'MEMBER' || github.event.comment.author_association == 'COLLABORATOR' || github.event.comment.author_association == 'CONTRIBUTOR') }}
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Ensure reviewer script exists
        run: |
          test -f .github/scripts/ai_review_comment.js
          echo "Found .github/scripts/ai_review_comment.js"

      - name: Run reviewer script
        env:
          GITHUB_TOKEN: ${{ secrets.AI_REVIEW_PAT }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: gpt-4.1
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: node .github/scripts/ai_review_comment.js
