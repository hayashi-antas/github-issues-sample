name: AI Review on /ai-review

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  issues: write

jobs:
  debug-context:
    runs-on: ubuntu-latest
    steps:
      - name: Print event debug info
        run: |
          echo "is_pr=${{ github.event.issue.pull_request != null }}"
          echo "comment_body=${{ toJson(github.event.comment.body) }}"
          echo "author=${{ github.event.comment.user.login }}"
          echo "author_association=${{ github.event.comment.author_association }}"
          echo "issue_number=${{ github.event.issue.number }}"
          echo "repo=${{ github.repository }}"

  ai-review:
    needs: debug-context
    if: ${{ github.event.issue.pull_request != null && contains(github.event.comment.body, '/ai-review') }}
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Run reviewer script
        env:
          GITHUB_TOKEN: ${{ secrets.AI_REVIEW_PAT }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_MODEL: ${{ vars.OPENAI_MODEL }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
        run: node .github/scripts/ai_review_comment.js
