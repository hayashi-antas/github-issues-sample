name: AI Review on /ai-review

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  ai-review:
    if: ${{ github.event.issue.pull_request && contains(github.event.comment.body, '/ai-review') }}
    runs-on: ubuntu-latest

    steps:
      - name: Generate and post AI review comment
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          MODEL: gpt-4.1
        run: |
          node - <<'NODE'
          const repo = process.env.REPO;
          const issueNumber = process.env.ISSUE_NUMBER;
          const ghToken = process.env.GITHUB_TOKEN;
          const openaiKey = process.env.OPENAI_API_KEY;
          const model = process.env.MODEL || "gpt-4.1";

          if (!openaiKey) {
            console.error("OPENAI_API_KEY is missing (GitHub Secrets)");
            process.exit(1);
          }

          async function ghJson(path, opts = {}) {
            const res = await fetch(`https://api.github.com${path}`, {
              ...opts,
              headers: {
                Authorization: `Bearer ${ghToken}`,
                Accept: "application/vnd.github+json",
                ...(opts.headers || {})
              }
            });
            if (!res.ok) throw new Error(`GitHub API ${res.status}: ${await res.text()}`);
            return res.json();
          }

          async function getPR() {
            // issue_number ã¨ PR number ã¯åŒã˜
            return ghJson(`/repos/${repo}/pulls/${issueNumber}`);
          }

          async function getDiff() {
            const res = await fetch(`https://api.github.com/repos/${repo}/pulls/${issueNumber}`, {
              headers: {
                Authorization: `Bearer ${ghToken}`,
                Accept: "application/vnd.github.v3.diff"
              }
            });
            if (!res.ok) throw new Error(`GitHub diff ${res.status}: ${await res.text()}`);
            return res.text();
          }

          function trimDiff(diff) {
            const maxChars = 120000;
            if (diff.length <= maxChars) return diff;
            return diff.slice(0, maxChars) + "\n\n[TRUNCATED]\n";
          }

          async function callOpenAI(pr, diff) {
            const prompt = `
ã‚ãªãŸã¯ç†Ÿç·´ã—ãŸã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚ä»¥ä¸‹ã®Pull Requestã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

## PRã‚¿ã‚¤ãƒˆãƒ«
${pr.title}

## PRæœ¬æ–‡
${pr.body || "(ãªã—)"}

## å¤‰æ›´å·®åˆ†ï¼ˆdiffï¼‰
${trimDiff(diff)}

è¦³ç‚¹:
- ãƒã‚°ã‚„è½ã¨ã—ç©´ï¼ˆå¢ƒç•Œæ¡ä»¶ã€ä¾‹å¤–ã€NULLã€åž‹ã€äº’æ›æ€§ï¼‰
- ä¿å®ˆæ€§ãƒ»å¯èª­æ€§ï¼ˆå‘½åã€è²¬å‹™ã€é‡è¤‡ã€ã‚³ãƒ¡ãƒ³ãƒˆã®å¿…è¦æ€§ï¼‰
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£/æƒ…å ±æ¼ãˆã„ï¼ˆãƒ­ã‚°ã€å…¥åŠ›æ¤œè¨¼ã€æ¨©é™ï¼‰
- ãƒ†ã‚¹ãƒˆè¦³ç‚¹ï¼ˆè¿½åŠ ã™ã¹ããƒ†ã‚¹ãƒˆã€ç¢ºèªãƒã‚¤ãƒ³ãƒˆï¼‰

ãƒˆãƒ¼ãƒ³:
- ä¸å¯§ã§å»ºè¨­çš„
- æ–­å®šã—ã™ãŽãªã„ï¼ˆæŽ¨æ¸¬ã¯æŽ¨æ¸¬ã¨æ›¸ãï¼‰
- åˆå¿ƒè€…ã«ã‚‚å­¦ã³ãŒã‚ã‚‹æ›¸ãæ–¹

å‡ºåŠ›ã¯Markdownã§ã€‚
            `.trim();

            const res = await fetch("https://api.openai.com/v1/responses", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${openaiKey}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({ model, input: prompt })
            });
            if (!res.ok) throw new Error(`OpenAI ${res.status}: ${await res.text()}`);

            const data = await res.json();
            return (data.output_text || "").trim() || "ï¼ˆAIãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼‰";
          }

          async function postComment(body) {
            const res = await fetch(`https://api.github.com/repos/${repo}/issues/${issueNumber}/comments`, {
              method: "POST",
              headers: {
                Authorization: `Bearer ${ghToken}`,
                "Content-Type": "application/json",
                Accept: "application/vnd.github+json"
              },
              body: JSON.stringify({
                body: `### ðŸ¤– AI Review\n\n${body}\n\n---\n_Trigger: /ai-review_`
              })
            });
            if (!res.ok) throw new Error(`Comment post ${res.status}: ${await res.text()}`);
          }

          (async () => {
            const pr = await getPR();
            const diff = await getDiff();
            const review = await callOpenAI(pr, diff);
            await postComment(review);
            console.log("AI review posted.");
          })().catch(err => {
            console.error(err);
            process.exit(1);
          });
          NODE
