name: AI Review on /ai-review

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  ai-review:
    # PRã‚³ãƒ¡ãƒ³ãƒˆ & /ai-review ã®ã¨ãã ã‘å‹•ã‹ã™
    if: >
      github.event.issue.pull_request &&
      contains(github.event.comment.body, '/ai-review')

    runs-on: ubuntu-latest

    steps:
      - name: Run AI review
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          REPO: ${{ github.repository }}
          ISSUE_NUMBER: ${{ github.event.issue.number }}
          MODEL: gpt-4.1
        run: |
          node - <<'NODE'
          const repo = process.env.REPO;
          const issueNumber = process.env.ISSUE_NUMBER;
          const ghToken = process.env.GITHUB_TOKEN;
          const openaiKey = process.env.OPENAI_API_KEY;
          const model = process.env.MODEL;

          const ghHeaders = {
            Authorization: `Bearer ${ghToken}`,
            Accept: "application/vnd.github+json"
          };

          async function gh(path, opts = {}) {
            const res = await fetch(`https://api.github.com${path}`, {
              ...opts,
              headers: { ...ghHeaders, ...(opts.headers || {}) }
            });
            if (!res.ok) throw new Error(await res.text());
            return res.json();
          }

          async function getPR() {
            return gh(`/repos/${repo}/pulls/${issueNumber}`);
          }

          async function getDiff() {
            const res = await fetch(
              `https://api.github.com/repos/${repo}/pulls/${issueNumber}`,
              {
                headers: {
                  Authorization: `Bearer ${ghToken}`,
                  Accept: "application/vnd.github.v3.diff"
                }
              }
            );
            return res.text();
          }

          async function callOpenAI(pr, diff) {
            const prompt = `
ã‚ãªãŸã¯ç†Ÿç·´ã—ãŸã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¨ãƒ³ã‚¸ãƒ‹ã‚¢ã§ã™ã€‚
ä»¥ä¸‹ã® Pull Request ã‚’ãƒ¬ãƒ“ãƒ¥ãƒ¼ã—ã¦ãã ã•ã„ã€‚

## PRã‚¿ã‚¤ãƒˆãƒ«
${pr.title}

## PRæœ¬æ–‡
${pr.body || "(ãªã—)"}

## å¤‰æ›´å·®åˆ†
${diff.slice(0, 120000)}

è¦³ç‚¹:
- ãƒã‚°ã‚„è½ã¨ã—ç©´
- ä¿å®ˆæ€§ãƒ»å¯èª­æ€§
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ä¸Šã®æ³¨æ„
- å°†æ¥å›°ã‚Šãã†ãªç‚¹

ãƒˆãƒ¼ãƒ³:
- ä¸å¯§
- æ–­å®šã—ã™ãŽãªã„
- å­¦ç¿’ç›®çš„ã«ã‚‚ãªã‚‹ã‚³ãƒ¡ãƒ³ãƒˆ

Markdownã§æ›¸ã„ã¦ãã ã•ã„ã€‚
            `.trim();

            const res = await fetch("https://api.openai.com/v1/responses", {
              method: "POST",
              headers: {
                Authorization: `Bearer ${openaiKey}`,
                "Content-Type": "application/json"
              },
              body: JSON.stringify({
                model,
                input: prompt
              })
            });

            const data = await res.json();
            return data.output_text || "ï¼ˆãƒ¬ãƒ“ãƒ¥ãƒ¼ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸï¼‰";
          }

          async function postComment(body) {
            await fetch(
              `https://api.github.com/repos/${repo}/issues/${issueNumber}/comments`,
              {
                method: "POST",
                headers: {
                  Authorization: `Bearer ${ghToken}`,
                  "Content-Type": "application/json"
                },
                body: JSON.stringify({
                  body: `### ðŸ¤– AI Review\n\n${body}`
                })
              }
            );
          }

          (async () => {
            const pr = await getPR();
            const diff = await getDiff();
            const review = await callOpenAI(pr, diff);
            await postComment(review);
          })();
          NODE
